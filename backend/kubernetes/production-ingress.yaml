# Production Ingress with SSL/TLS and security headers
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cdf-smarthub-ingress
  namespace: cdf-smarthub
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/rate-limit-requests-per-second: "100"
    nginx.ingress.kubernetes.io/rate-limit-connections: "10"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' wss:; media-src 'self'; object-src 'none'; child-src 'self'; form-action 'self'; base-uri 'self'";
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
spec:
  tls:
  - hosts:
    - api.cdf.gov.zm
    - app.cdf.gov.zm
    secretName: cdf-smarthub-tls
  rules:
  - host: api.cdf.gov.zm
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 3000
  - host: app.cdf.gov.zm
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
---
# Monitoring Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-ingress
  namespace: cdf-smarthub-monitoring
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - CDF Monitoring'
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
spec:
  tls:
  - hosts:
    - monitoring.cdf.gov.zm
    secretName: monitoring-tls
  rules:
  - host: monitoring.cdf.gov.zm
    http:
      paths:
      - path: /prometheus
        pathType: Prefix
        backend:
          service:
            name: prometheus
            port:
              number: 9090
      - path: /grafana
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
---
# Certificate Issuer for Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: tech@cdf.gov.zm
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
          podTemplate:
            spec:
              nodeSelector:
                "kubernetes.io/os": linux
---
# Staging Certificate Issuer (for testing)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: tech@cdf.gov.zm
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: nginx
---
# Basic Auth Secret for Monitoring
apiVersion: v1
kind: Secret
metadata:
  name: monitoring-auth
  namespace: cdf-smarthub-monitoring
type: Opaque
data:
  auth: YWRtaW46JGFwcjEkSDZsUU5WNVMkWUhaUE1RODcwS0VvOTh6emJtUDYzLgoK # admin:$apr1$H6lQNV5S$YHZPMq870KEo98zzbmP63. (admin:admin123)
---
# WAF Configuration (if using ModSecurity)
apiVersion: v1
kind: ConfigMap
metadata:
  name: modsec-config
  namespace: cdf-smarthub
data:
  modsecurity.conf: |
    SecRuleEngine On
    SecDefaultAction "phase:1,log,auditlog,deny,status:403"
    SecDefaultAction "phase:2,log,auditlog,deny,status:403"
    
    # OWASP CRS rules
    Include /opt/owasp-modsecurity-crs/crs-setup.conf
    Include /opt/owasp-modsecurity-crs/rules/*.conf
    
    # Custom rules for CDF Smart Hub
    SecRule REQUEST_METHOD "!@within GET POST PUT DELETE PATCH OPTIONS HEAD" \
        "id:10001,\
        phase:1,\
        block,\
        msg:'Invalid HTTP Method',\
        logdata:'Method: %{REQUEST_METHOD}'"
    
    SecRule REQUEST_FILENAME "@detectSQLi" \
        "id:10002,\
        phase:2,\
        block,\
        msg:'SQL Injection Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
    
    SecRule ARGS "@detectXSS" \
        "id:10003,\
        phase:2,\
        block,\
        msg:'XSS Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
---
# Rate Limiting Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-rate-limit
  namespace: cdf-smarthub
data:
  nginx.conf: |
    # Define rate limiting zones
    http {
        # General API rate limiting
        limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;
        
        # Authentication endpoints (stricter limits)
        limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/m;
        
        # File upload endpoints
        limit_req_zone $binary_remote_addr zone=upload:10m rate=20r/m;
        
        # Admin endpoints
        limit_req_zone $binary_remote_addr zone=admin:10m rate=30r/m;
        
        server {
            listen 80;
            server_name api.cdf.gov.zm;
            
            # Apply rate limits based on location
            location /api/v1/auth/ {
                limit_req zone=auth burst=5 nodelay;
                proxy_pass http://api-gateway:3000;
            }
            
            location /api/v1/documents/upload {
                limit_req zone=upload burst=3 nodelay;
                proxy_pass http://api-gateway:3000;
            }
            
            location /api/v1/admin/ {
                limit_req zone=admin burst=10 nodelay;
                proxy_pass http://api-gateway:3000;
            }
            
            location /api/ {
                limit_req zone=api burst=20 nodelay;
                proxy_pass http://api-gateway:3000;
            }
        }
    }