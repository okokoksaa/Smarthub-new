-- =====================================================
-- TEST: Verify Vulnerability Scoring Trigger
-- Run this AFTER 20260125182500_add_vulnerability_scoring.sql
-- Expected: vulnerability_score = 60 (DOUBLE_ORPHAN=40 + DISABLED=20)
-- =====================================================

-- Insert dummy DOUBLE_ORPHAN + DISABLED student and verify score
WITH ins AS (
  INSERT INTO public.bursary_applications (
    application_number,
    constituency_id,
    academic_year,
    student_name,
    institution_name,
    institution_type,
    orphan_status,
    disability_status
  ) VALUES (
    'BUR-TEST-' || TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
    (SELECT id FROM public.constituencies LIMIT 1),
    2026,
    'Test Student - Vulnerability Scoring Verification',
    'University of Zambia',
    'university',
    'DOUBLE_ORPHAN'::public.orphan_status_type,
    'DISABLED'::public.disability_status_type
  )
  RETURNING id
)
SELECT
  b.id,
  b.application_number,
  b.student_name,
  b.orphan_status,
  b.disability_status,
  b.vulnerability_score,
  CASE
    WHEN b.vulnerability_score = 60 THEN 'PASS: Trigger correctly calculated 60 points'
    ELSE 'FAIL: Expected 60, got ' || b.vulnerability_score
  END AS test_result
FROM public.bursary_applications b
JOIN ins ON ins.id = b.id;

-- Cleanup: Remove test record (optional - comment out to keep test data)
-- DELETE FROM public.bursary_applications WHERE student_name = 'Test Student - Vulnerability Scoring Verification';
