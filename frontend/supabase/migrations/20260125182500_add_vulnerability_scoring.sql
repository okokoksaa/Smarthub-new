-- =====================================================
-- MIGRATION: Add Vulnerability Scoring to Bursary Applications
-- Description: Adds orphan_status, disability_status, and vulnerability_score
--              with auto-calculation trigger
-- Points: DOUBLE_ORPHAN=40, SINGLE_ORPHAN=20, DISABLED=20
-- =====================================================

-- 1) Create ENUM types if they don't already exist
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'orphan_status_type') THEN
    CREATE TYPE public.orphan_status_type AS ENUM ('NOT_ORPHAN', 'SINGLE_ORPHAN', 'DOUBLE_ORPHAN');
  END IF;
END
$$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'disability_status_type') THEN
    CREATE TYPE public.disability_status_type AS ENUM ('NOT_DISABLED', 'DISABLED');
  END IF;
END
$$;

-- 2) Add columns to bursary_applications (idempotent)
ALTER TABLE public.bursary_applications
  ADD COLUMN IF NOT EXISTS orphan_status public.orphan_status_type DEFAULT 'NOT_ORPHAN',
  ADD COLUMN IF NOT EXISTS disability_status public.disability_status_type DEFAULT 'NOT_DISABLED',
  ADD COLUMN IF NOT EXISTS vulnerability_score INTEGER DEFAULT 0;

-- 3) Create trigger function to auto-calculate vulnerability_score
CREATE OR REPLACE FUNCTION public.bursary_applications_set_vulnerability_score()
RETURNS trigger
LANGUAGE plpgsql
SECURITY INVOKER
SET search_path = public
AS $func$
DECLARE
  score integer := 0;
BEGIN
  -- Orphan status points
  IF NEW.orphan_status = 'DOUBLE_ORPHAN'::public.orphan_status_type THEN
    score := score + 40;
  ELSIF NEW.orphan_status = 'SINGLE_ORPHAN'::public.orphan_status_type THEN
    score := score + 20;
  END IF;

  -- Disability status points
  IF NEW.disability_status = 'DISABLED'::public.disability_status_type THEN
    score := score + 20;
  END IF;

  NEW.vulnerability_score := score;
  RETURN NEW;
END;
$func$;

-- 4) Create trigger on INSERT and UPDATE
DROP TRIGGER IF EXISTS bursary_applications_vulnerability_score_trg ON public.bursary_applications;

CREATE TRIGGER bursary_applications_vulnerability_score_trg
BEFORE INSERT OR UPDATE ON public.bursary_applications
FOR EACH ROW
EXECUTE FUNCTION public.bursary_applications_set_vulnerability_score();

-- 5) Backfill existing rows to set initial vulnerability_score
UPDATE public.bursary_applications
SET vulnerability_score =
  (CASE orphan_status
     WHEN 'DOUBLE_ORPHAN'::public.orphan_status_type THEN 40
     WHEN 'SINGLE_ORPHAN'::public.orphan_status_type THEN 20
     ELSE 0
   END)
  +
  (CASE disability_status
     WHEN 'DISABLED'::public.disability_status_type THEN 20
     ELSE 0
   END);

-- 6) Create index for vulnerability-based queries
CREATE INDEX IF NOT EXISTS idx_bursary_applications_vulnerability
ON public.bursary_applications(vulnerability_score DESC);
